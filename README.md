# Message Bot v2.0

[![Kotlin](https://img.shields.io/badge/Kotlin-1.9.22-blue.svg?logo=kotlin)](https://kotlinlang.org)
[![Gradle](https://img.shields.io/badge/Gradle-8.13-blue.svg?logo=gradle)](https://gradle.org)

> **"Message"** — це комплексний програмний продукт, що розробляється як центральний інструмент для автоматизації процесів та збагачення користувацького досвіду в офіційній україномовній спільноті гри `Mindustry`.

Цей документ є вичерпним технічним завданням (ТЗ), що визначає повні функціональні та нефункціональні вимоги до розробки Discord-бота "Message".

---

## Ключові особливості

- **Система моніторингу та логування:** Надійний збір та структуроване представлення даних про всі події на сервері.
- **Функціональні утиліти:** Набір унікальних утиліт, тісно інтегрованих з `Mindustry`.
- **Інтелектуальний модератор:** Проактивний ШІ агент (Google Gemini) для автоматичного аналізу контенту, виявлення порушень та вживання відповідних заходів.
- **Україноцентричність:** Уся взаємодія з ботом здійснюється виключно українською мовою.
- **Контекстуальність:** Глибоке розуміння контексту повідомлень, каналів та історії користувачів.

---

## Зміст

<details>
<summary>Натисніть, щоб розгорнути зміст</summary>

- [**1. Загальні положення**](#1-загальні-положення)
  - [1.1. Мета документа](#11-мета-документа)
  - [1.2. Огляд проєкту](#12-огляд-проєкту)
  - [1.3. Цільова аудиторія](#13-цільова-аудиторія)
- [**2. Ключові концепції та архітектура**](#2-ключові-концепції-та-архітектура)
  - [2.1. Філософія бота](#21-філософія-бота)
  - [2.2. Архітектура системи](#22-архітектура-системи)
  - [2.3. Внутрішні модулі та сервіси](#23-внутрішні-модулі-та-сервіси)
- [**3. Функціональні вимоги: Система логування**](#3-функціональні-вимоги-система-логування)
  - [3.1. Технічні логи](#31-технічні-логи)
  - [3.2. Канали для Адміністрації та Модерації](#32-канали-для-адміністрації-та-модерації-розширено)
  - [3.3. Тематичні канали логів](#33-тематичні-канали-логів)
- [**4. Функціональні вимоги: Модуль AI-Модератор "Вартовий"**](#4-функціональні-вимоги-модуль-ai-модератор-вартовий)
  - [4.1. Джерела даних для аналізу](#41-джерела-даних-для-аналізу)
  - [4.2. Логіка аналізу та прийняття рішень](#42-логіка-аналізу-та-прийняття-рішень)
  - [4.3. Моделі поведінки та дій](#43-моделі-поведінки-та-дій)
  - [4.4. Механізм зворотного зв'язку](#44-механізм-зворотного-звязку)
- [**5. Функціональні вимоги: Детальний опис команд**](#5-функціональні-вимоги-детальний-опис-команд-та-їх-логіка)
  - [5.1. Система прав доступу](#51-система-прав-доступу-до-команд)
  - [5.2. Команди модерації](#52-команди-модерації)
  - [5.3. Команди для спільноти та утиліти](#53-команди-для-спільноти-та-утиліти)
  - [5.4. Команди, специфічні для `Mindustry`](#54-команди-специфічні-для-mindustry)
  - [5.5. Інструменти для Адміністрації](#55-інші-інструменти-команди-серверу)
- [**6. Візуальний та стилістичний гайд**](#6-візуальний-та-стилістичний-гайд)
- [**7. Нефункціональні вимоги**](#7-нефункціональні-вимоги)
- [**8. План розробки**](#8-план-розробки-версії-20)

</details>

---

## **1. Загальні положення**

### **1.1. Мета документа**
Цей документ є вичерпним технічним завданням (ТЗ), що визначає повні функціональні та нефункціональні вимоги до розробки Discord-бота "Message" (далі — Бот). Він слугує єдиним джерелом правди для розробників, тестувальників та адміністраторів проєкту на всіх етапах життєвого циклу продукту. Метою даного ТЗ є усунення будь-якої двозначності та необхідності звернення до додаткових обговорень, надаючи чіткі та деталізовані інструкції для реалізації.

### **1.2. Огляд проєкту**
"Message" — це комплексний програмний продукт, що розробляється як центральний інструмент для автоматизації процесів та збагачення користувацького досвіду в офіційній україномовній спільноті гри `Mindustry`. Бот є другою ітерацією проєкту і покликаний виконувати три ключові ролі:
1.  **Система моніторингу та логування:** Надійний збір та структуроване представлення даних про всі події на сервері.
2.  **Функціональні утиліти:** Набір унікальних утиліт, тісно інтегрованих з `Mindustry`.
3.  **Інтелектуальний модератор:** Проактивний ШІ агент, що використовує велику мультимодалну модель (Google Gemini) для автоматичного аналізу контенту, виявлення порушень та вживання відповідних заходів.

### **1.3. Цільова аудиторія**
-   **Адміністрація та Модерація:** Ключові користувачі, що отримують інструменти для управління спільнотою.
-   **Учасники спільноти:** Користувачі, що взаємодіють з утилітами бота.

---

## **2. Ключові концепції та архітектура**

### **2.1. Філософія бота**
Функціонування бота базується на чотирьох основних принципах, що визначають його поведінку та взаємодію з користувачами:

-   **Інтегрованість:** Бот не є стороннім інструментом. Його функціонал тісно переплетений з тематикою спільноти `Mindustry`, що реалізується через парсинг специфічних для гри файлів (`.msch`, `.msav`), надання доступу до ресурсів гри та симуляцію ігрових механік.
-   **Україноцентричність:** Уся текстова взаємодія з ботом, включаючи назви команд, описи, повідомлення та відповіді, здійснюється виключно українською мовою, що підкреслює ідентичність та створює комфортне середовище для цільової аудиторії.
-   **Проактивність:** Бот не обмежується пасивною реакцією на команди. Він активно моніторить сервер у фоновому режимі, виявляючи порушення правил без прямого втручання людини та, залежно від серйозності ситуації, самостійно застосовує заходи та/або інформує команду модераторів.
-   **Контекстуальність:** Кожне рішення, особливо прийняте ШІ-модулем, базується на глибокому розумінні контексту. Бот аналізує не лише саме повідомлення, а й попередню розмову, опис та призначення каналу, а також історію взаємодії з конкретним користувачем.

### **2.2. Архітектура системи**
Система бота є модульною, що забезпечує гнучкість розробки та легкість подальшого розширення. Вона складається з чотирьох основних логічних блоків:

-   **Система логування:** Модуль, що відповідає за перехоплення, обробку та збереження інформації про всі події на сервері у визначених форматах та сховищах.
-   **Інтеграції з API:** Набір класів та функцій для взаємодії із зовнішніми сервісами: Discord API (основна взаємодія), Google Gemini API (для ШІ-аналізу) та GitHub API (для специфічних команд `Mindustry`).
-   **Обробник команд:** Модуль, що відповідає за реєстрацію, парсинг та виконання слеш-команд, ініційованих користувачами.
-   **AI-Модератор:** Асинхронний фоновий процес, що отримує дані від системи логування, аналізує їх за допомогою ШІ та ініціює відповідні дії.

### **2.3. Внутрішні модулі та сервіси**
Для реалізації специфічного для `Mindustry` функціоналу бот містить два ключові внутрішні сервіси:

-   **Парсер контенту `Mindustry`:** Спеціалізований внутрішній модуль, відповідальний за роботу з файлами гри.
-   **Емулятор `Mindustry` логіки:** Внутрішній модуль, що реалізує спрощену копію вмісту для виконання коду логічних процесорів.

---

## **3. Функціональні вимоги: Система логування**

### **3.1. Технічні логи**
-   **Призначення:** Створення вичерпного, надійного та машиночитабельного журналу всіх без винятку подій на сервері.
-   **Канал:** `#технічний-лог` (приватний).
-   **Формат запису:** `Logfmt`.
    ```
    ts=2025-05-21T18:00:00.123Z event=message_created event_id="uuid" author_id="123" channel_id="456" message_id="789" content="Привіт, світ!"
    ts=2025-05-21T18:00:01.456Z event=message_deleted event_id="uuid" author_id="123" channel_id="456" message_id="789" cached_content="Привіт, світ!" reason="Користувач сказав "це погане слово""
    ```

### **3.2. Канали для Адміністрації та Модерації (Розширено)**
-   `#дії-модераторів`: Єдина стрічка всіх дій модерації.
-   `#стан-бота`: Повідомлення про технічний стан бота.
-   `#підозри-ші`: Детальні звіти від ШІ про неоднозначні потенційні порушення з кнопками для швидких дій.

### **3.3. Тематичні канали логів**
-   `#логи-видалення`: Embed з даними про кожне видалене повідомлення.
-   `#логи-редакції`: Embed з порівнянням повідомлення "до" та "після" редакції.
-   `#логи-учасники`: Embed'и про приєднання/вихід учасників, зміну у їхніх профілях або ролях.
-   `#звіти-войс`: Фінальні звіти по завершенню голосових сесій з самарі від ШІ.

---

## **4. Функціональні вимоги: Модуль AI-Модератор "Вартовий"**

### **4.1. Джерела даних для аналізу**
-   **Текст:** Вміст нових та відредагованих повідомлень.
-   **Мультимедіа:** Зображення, GIF, аудіо, відео, посилання.
-   **Аудіопотік:** Безперервний аналіз розмов у голосових каналах.
-   **Профілі користувачів:** Аналіз нікнеймів, аватарів, банерів та описів при зміні.

### **4.2. Логіка аналізу та прийняття рішень**
1.  **Побудова запиту до Gemini:** Для кожної події бот формує деталізований запит. Він включає контент для аналізу (текст, зображення тощо) та розширений контекст:
    *   Назва та опис каналу, де відбулася подія.
    *   Ролі користувача, що ініціював подію.
    *   Історія повідомлень з каналу та релевантні дані з довгострокової пам'яті (RAG).
2.  **Архітектура довгострокової пам'яті (RAG):** Використання векторної бази даних для надання ШІ доступу до релевантної історії сервера.
3.  **Ескалація покарань:** Система не банить автоматично за накопиченням попереджень, а створює звіт для модераторів.

### **4.3. Моделі поведінки та дій**
-   **Автоматична дія:** `confidence_score > 90%` та високий `severity_score`.
-   **Сповіщення:** `confidence_score > 70%`. Надсилається звіт у `#підозри-ші`.
-   **"М'яке" втручання:** `confidence_score > 90%` та низький `severity_score`. Бот робить дружнє зауваження в чаті.

### **4.4. Механізм зворотного зв'язку**
Кнопка `[Помилкове спрацювання]` у звітах ШІ дозволяє модераторам надавати фідбек для майбутнього донавчання моделі.

---

## **5. Функціональні вимоги: Детальний опис команд та їх логіка**

### **5.1. Система прав доступу до команд**
Використовується гібридний підхід: права за замовчуванням в Discord API, можливість їх перепризначення в налаштуваннях сервера та додаткова перевірка ролей в коді бота.

### **5.2. Команди модерації**
<details>
<summary><code>/попередити</code></summary>

- **Призначення:** Видача офіційного попередження учаснику.
- **Аргументи:** `користувач`, `правила`, `причина` (опц.), `посилання` (опц.).
</details>

<details>
<summary><code>/блок</code></summary>

- **Призначення:** Блокування учасника (тимчасове або перманентне).
- **Аргументи:** `користувач`, `час` (опц.), `правила`, `причина` (опц.).
</details>

<details>
<summary><code>/зняти-попередження</code></summary>

- **Призначення:** Видалення раніше виданого попередження через інтерактивне меню.
- **Аргументи:** `користувач`.
</details>

<details>
<summary><code>/очистити-історію</code></summary>

- **Призначення:** Повне анулювання всіх записів про попередження для учасника.
- **Аргументи:** `користувач`.
</details>

<details>
<summary><code>/історія-покарань</code></summary>

- **Призначення:** Перегляд історії покарань учасника (своєї або іншого, якщо є права).
- **Аргументи:** `користувач` (опц.).
</details>

<details>
<summary><code>/очистити-чат</code></summary>

- **Призначення:** Видалення вказаної кількості останніх повідомлень у каналі.
- **Аргументи:** `кількість`.
</details>

### **5.3. Команди для спільноти та утиліти**
<details>
<summary><code>/інфо</code></summary>

- **Призначення:** Надання доступу до бази знань сервера (ЧаПи, Правила).
- **Аргументи:** `тип`, `розділ_чапів` (опц.), `публічно` (опц.).
</details>

<details>
<summary><code>/аватар</code></summary>

- **Призначення:** Показати аватар учасника у великому розмірі.
- **Аргументи:** `користувач`.
</details>

<details>
<summary><code>/загуглити</code></summary>

- **Призначення:** Виконати безпечний пошук у Google та надати результат у стилі "Let Me Google That For You".
- **Аргументи:** `запит`.
</details>

<details>
<summary><code>/пінг</code></summary>

- **Призначення:** Перевірити статус ігрового сервера `Mindustry`.
- **Аргументи:** `ip`.
</details>

### **5.4. Команди, специфічні для `Mindustry`**
<details>
<summary><code>/опублікувати</code></summary>

- **Призначення:** Єдиний спосіб публікації схем та мап у відповідних каналах-форумах.
- **Аргументи:** `файл` або `текст`.
- **Логіка:** Парсить файл/текст, відкриває модальне вікно для редагування назви/опису/тегів, модифікує вихідний файл та створює пост.
</details>

<details>
<summary><code>/верифікація-розробника</code></summary>

- **Призначення:** Автоматична верифікація розробників модів через GitHub для отримання ролі.
- **Аргументи:** `репозиторій` (опц.).
</details>

<details>
<summary><code>/випадковий</code></summary>

- **Призначення:** Показати випадкову схему або мапу зі спільноти.
- **Аргументи:** `тип` (`Схема`/`Мапа`).
</details>

<details>
<summary><code>/додати-локалізації</code></summary>

- **Призначення:** Допомогти розробникам модів додати файли локалізації до їх архіву.
- **Аргументи:** `файл.zip` (опц.).
</details>

<details>
<summary><code>/знайти-ресурс</code></summary>

- **Призначення:** Знайти файл ігрового ресурсу в репозиторіях `Mindustry`.
- **Аргументи:** `запит`.
</details>

<details>
<summary><code>/симуляція-коду</code></summary>

- **Призначення:** Виконати симуляцію логічного коду `Mindustry` (`.mpp`).
- **Аргументи:** `код`.
</details>

### **5.5. Інші інструменти команди серверу**
<details>
<summary><code>/опублікувати-новину</code></summary>

- **Призначення:** Створення кастомізованих повідомлень у каналі новин через зовнішній веб-редактор.
</details>

<details>
<summary><code>/переіндексувати-пам'ять</code></summary>

- **Призначення:** Запустити процес повної перебудови векторної бази даних для ШІ.
</details>

---

## **6. Візуальний та стилістичний гайд**

-   **Першоджерело стилю:** Єдиним джерелом правди є набір концепт-вебхуків, наданих розробником.
-   **Тон голосу (Tone of Voice):** Професійний, з можливими легкими та ледь помітними жартами. Звернення на "ви". Мова — жива, зрозуміла українська.

---

## **7. Нефункціональні вимоги**

-   **Продуктивність:** Час відповіді < 3с (з `deferReply`), управління лімітами API.
-   **Надійність:** Робота 24/7, автоматичний перезапуск, коректна обробка помилок.
-   **Безпека:** Зберігання токенів у змінних середовища, валідація вводу.
-   **Конфігурація:** Всі ключові параметри (токени, ID каналів/ролей, налаштування ШІ) винесені в `.env` файл.

---

## **8. План розробки версії 2.0**

Розробка ведеться поетапно, за визначеними віхами (milestones).

<details>
<summary><strong>Віха 1: Основа та інфраструктура (Sprint 1)</strong></summary>

- [ ] **Задачі:**
    - [ ] Створення структури проєкту, налаштування середовища розробки.
    - [ ] Підключення до Discord API, реалізація базового клієнта.
    - [ ] Створення обробника слеш-команд.
    - [ ] Реалізація повної системи логування.
    - [ ] Створення механізму завантаження конфігурації з файлу.
- [ ] **Критерії завершення:** Бот успішно запускається, логує усі стандартні Discord події, відповідає на одну тестову команду.
</details>

<details>
<summary><strong>Віха 2: Модуль модерації (Sprint 2)</strong></summary>

- [ ] **Задачі:**
    - [ ] Реалізація повного функціоналу всіх команд модерації.
    - [ ] Налаштування системи видачі ролей та прав доступу.
    - [ ] Налаштування інтерактивних елементів (кнопки, списки, пагінація).
- [ ] **Критерії завершення:** Усі команди модерації працюють згідно з ТЗ.
</details>

<details>
<summary><strong>Віха 3: Модулі спільноти та `Mindustry` (Sprint 3-4)</strong></summary>

- [ ] **Задачі:**
    - [ ] Реалізація всіх команд для спільноти та `Mindustry`.
    - [ ] Інтеграція з API GitHub.
    - [ ] Розробка внутрішніх модулів: Парсер та Емулятор `Mindustry`.
- [ ] **Критерії завершення:** Усі команди працюють згідно з ТЗ.
</details>

<details>
<summary><strong>Віха 4: Інтеграція AI-Модератора (MVP) (Sprint 5)</strong></summary>

- [ ] **Задачі:**
    - [ ] Підключення до API Google Gemini.
    - [ ] Реалізація фонового аналізу тексту та зображень.
    - [ ] Впровадження логіки прийняття рішень.
- [ ] **Критерії завершення:** Бот автоматично реагує на порушення та повідомляє про підозри.
</details>

<details>
<summary><strong>Віха 5: MVP веб-редактора новин (Sprint 6)</strong></summary>

- [ ] **Задачі:**
    - [ ] Розгортання інфраструктури для веб-додатку (Frontend/Backend).
    - [ ] Реалізація автентифікації через Discord OAuth2.
    - [ ] Створення MVP інтерфейсу редактора.
    - [ ] Налаштування взаємодії між веб-додатком та ботом.
- [ ] **Критерії завершення:** Можна створити та опублікувати новину через веб-інтерфейс.
</details>

<details>
<summary><strong>Віха 6: Тестування та впровадження (Sprint 7)</strong></summary>

- [ ] **Задачі:**
    - [ ] Комплексне тестування всіх модулів.
    - [ ] Виправлення помилок та оптимізація.
    - [ ] Підготовка інструкцій для адміністраторів.
    - [ ] Фінальне розгортання.
- [ ] **Критерії завершення:** Продукт розгорнуто, стабільно працює та відповідає всім вимогам ТЗ.
</details>

